#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
STAMP_FILE="$ROOT_DIR/.last_test_run"

if [ ! -f "$STAMP_FILE" ]; then
  echo "[pre-commit] No test stamp found. Run scripts/run_smoke.sh first." >&2
  exit 1
fi

.venv/bin/python - <<'PY'
import subprocess
import sys
from datetime import datetime, timezone
from pathlib import Path

root = Path(subprocess.check_output(["git", "rev-parse", "--show-toplevel"], text=True).strip())
stamp = root / '.last_test_run'
try:
    ts = stamp.read_text().strip()
    stamp_time = datetime.strptime(ts, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)
except Exception:
    print("[pre-commit] Invalid test stamp. Re-run scripts/run_smoke.sh", file=sys.stderr)
    sys.exit(1)

age_minutes = (datetime.now(timezone.utc) - stamp_time).total_seconds() / 60
if age_minutes > 120:
    print("[pre-commit] Test stamp too old (>120m). Re-run scripts/run_smoke.sh", file=sys.stderr)
    sys.exit(1)
PY

exit 0
