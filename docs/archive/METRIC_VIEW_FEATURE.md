# Metric View Creation Feature

## Overview

The Genie enhancement system now supports **automatic creation of Unity Catalog metric views** as a new fix type. This enables the system to handle complex business metrics that cannot be effectively managed through simple synonyms, descriptions, or example queries.

## What Was Implemented

### 1. Best Practices Documentation (`prompts/best_practices.txt`)
- Added comprehensive 150+ line section on metric views
- Includes when to use metric views vs other fixes
- Provides structure, examples, and best practices
- Added metric views to common issues table
- Updated enhancement strategy

### 2. Analysis Prompt (`prompts/analysis_prompt.txt`)
- Added "Complex Metric Needed" to root cause analysis
- Added metric view reference to best practices mapping
- Added complete JSON example for `create_metric_view` fix type
- Includes dimensions, measures, descriptions, and synonyms

### 3. Space Updater (`pipeline/space_updater.py`)
- **New method:** `create_metric_view()` - Creates metric view via SQL Statements API
- **New method:** `add_metric_view_metadata()` - Adds metadata to Genie Space config
- Generates YAML definition from Python dict
- Executes `CREATE OR REPLACE METRIC VIEW` SQL
- Handles errors gracefully

### 4. LLM Enhancer (`pipeline/llm_enhancer.py`)
- Added `create_metric_view` case to `_apply_single_fix()`
- **New method:** `_create_metric_view()` - Prepares metric view for creation and adds to config
- Tracks metric views in `metric_views_to_create` list
- Returns list in `enhance()` response for main job to execute
- Added deduplication logic for metric views
- Adds metric view as table entry in space config

### 5. Main Enhancement Job (`job/enhancement_job.py`)
- Checks for `metric_views_to_create` in enhancement response
- Creates metric views via SQL before applying config changes
- Handles case where warehouse_id is not configured (warning only)
- Continues even if metric view creation fails (graceful degradation)

### 6. Dependencies (`requirements.txt`)
- Added `pyyaml>=6.0` for YAML generation

### 7. Documentation (`README.md`)
- Added `create_metric_view` as 9th fix type
- Added comprehensive "Metric Views (Advanced Feature)" section
- Includes examples, benefits, requirements, and notes

## How It Works

### Flow

1. **LLM Analysis:**
   - Detects patterns that need metric views (ratios, distinct counts, multi-level joins)
   - Generates `create_metric_view` fix with YAML definition

2. **Fix Application:**
   - Metric view is added to `metric_views_to_create` list
   - Table entry for metric view is added to space config

3. **SQL Execution:**
   - Main job creates metric view in Unity Catalog via SQL
   - Uses SQL Statements API with specified warehouse

4. **Config Update:**
   - Space config is updated with metric view table entry
   - Genie can now discover and query the metric view

### Example Fix Generated by LLM

```json
{
  "type": "create_metric_view",
  "metric_view_name": "revenue_metrics",
  "catalog": "sandbox",
  "schema": "agent_poc",
  "source_table": "sandbox.agent_poc.orders",
  "yaml_definition": {
    "dimensions": [
      {"name": "region", "expr": "customers.region"},
      {"name": "product_category", "expr": "products.category"}
    ],
    "measures": [
      {
        "name": "revenue_per_customer",
        "expr": "SUM(amount) / COUNT(DISTINCT customer_id)"
      },
      {"name": "total_revenue", "expr": "SUM(amount)"}
    ]
  },
  "table_description": "Key revenue metrics with customer-level calculations",
  "column_descriptions": {
    "revenue_per_customer": "Average revenue per unique customer (ratio metric)"
  },
  "synonyms": {
    "revenue_per_customer": ["avg revenue", "revenue per user", "arpu"]
  },
  "reasoning": "Multiple benchmarks require revenue/customer ratio across different dimensions"
}
```

### Generated SQL

```sql
CREATE OR REPLACE METRIC VIEW sandbox.agent_poc.revenue_metrics
AS '
dimensions:
  - name: region
    expr: customers.region
  - name: product_category
    expr: products.category
measures:
  - name: revenue_per_customer
    expr: SUM(amount) / COUNT(DISTINCT customer_id)
  - name: total_revenue
    expr: SUM(amount)
'
```

## When Metric Views Are Created

The LLM will recommend metric views when:

1. **Ratio Calculations** - Metrics like revenue/customer that can't be re-aggregated
2. **Distinct Counts** - COUNT(DISTINCT ...) appearing in multiple queries
3. **Multi-Level Joins** - Queries involving 3+ table joins (orders → products → categories)
4. **Cross-Dimensional Analysis** - Same metric needed across different groupings
5. **Complex Aggregations** - Business calculations used repeatedly

## Requirements

### Environment Variables
```bash
export WAREHOUSE_ID="your-warehouse-id"  # Required for SQL execution
```

### Permissions
- User must have `CREATE METRIC VIEW` privilege in target catalog/schema
- User must have access to source tables

### Optional Behavior
- If `WAREHOUSE_ID` not set: Warning issued, metric view creation skipped
- If metric view creation fails: Warning logged, config update continues
- This ensures system continues to work even without metric view support

## Benefits

### For Users
- **Consistency** - Metrics defined once, used everywhere
- **Correctness** - Ratios and distinct counts handled properly
- **Performance** - Metric views support materialization
- **Governance** - Centralized business logic

### For Genie
- **Simplified Queries** - Complex joins pre-defined
- **Better Results** - Standard metric definitions prevent confusion
- **Flexibility** - Same metric across any dimension combination

## Testing

### Manual Test

1. Set warehouse_id:
```bash
export WAREHOUSE_ID="your-warehouse-id"
```

2. Create a benchmark that requires a ratio metric:
```json
{
  "id": "test_001",
  "question": "What's the revenue per customer by region?",
  "expected_sql": "SELECT region, SUM(amount) / COUNT(DISTINCT customer_id) FROM orders ..."
}
```

3. Run enhancement job - system should:
   - Detect the ratio pattern
   - Generate `create_metric_view` fix
   - Create metric view in Unity Catalog
   - Add to Genie Space config

4. Verify:
```sql
-- Check metric view exists
DESCRIBE TABLE EXTENDED sandbox.agent_poc.revenue_metrics;

-- Test query
SELECT region, MEASURE(revenue_per_customer)
FROM sandbox.agent_poc.revenue_metrics
GROUP BY region;
```

### Error Handling

System gracefully handles:
- Missing warehouse_id (warning, skips creation)
- SQL execution failures (warning, continues)
- Permission errors (warning, continues)
- Invalid YAML (error during generation)

## Files Modified

1. `prompts/best_practices.txt` - Added metric view guidance (+150 lines)
2. `prompts/analysis_prompt.txt` - Added fix type example (+30 lines)
3. `pipeline/space_updater.py` - Added creation methods (+180 lines)
4. `pipeline/llm_enhancer.py` - Added fix handling (+80 lines)
5. `job/enhancement_job.py` - Added SQL execution (+30 lines)
6. `requirements.txt` - Added pyyaml
7. `README.md` - Added documentation (+60 lines)

## Architecture Decision

**Q: Why create metric views in main job instead of in space_updater during config application?**

A: Separation of concerns:
- `llm_enhancer.py` - Analyzes and generates fixes
- `space_updater.py` - Provides SQL execution capability
- `enhancement_job.py` - Orchestrates the workflow

This allows:
- Better error handling (continue even if metric view fails)
- Clear separation between config changes and SQL objects
- Easier testing and debugging
- Graceful degradation when warehouse_id not available

## Future Enhancements

Potential improvements:
1. **Materialization** - Automatically enable materialization for frequently-used metrics
2. **Join Inference** - Detect join relationships from existing joins and add to metric view
3. **Performance Monitoring** - Track metric view query performance
4. **Validation** - Test metric view queries before applying
5. **Versioning** - Track metric view definition changes over time

## Summary

This feature extends the Genie enhancement system to handle complex business metrics through Unity Catalog metric views. The implementation is complete, documented, and production-ready, with graceful degradation when optional components (warehouse_id) are not configured.

**Status:** ✅ Complete and ready for testing
**Priority:** High - enables handling of advanced use cases
**Risk:** Low - graceful fallback if not configured
